name: Update Python dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1" # Mondays 04:00 UTC

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: updatedep-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # Dependency compilation should be quick
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-deps-${{ hashFiles('**/requirements.in') }}
          restore-keys: |
            ${{ runner.os }}-pip-deps-
            ${{ runner.os }}-pip-

      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Compile requirements with pip-compile
        run: |
          set -euxo pipefail
          services=(skodaimporter skodachargefinder skodachargefrontend skodaupdatechargeprices skodachargecollector)
          for d in "${services[@]}"; do
            if [ -f "$d/requirements.in" ]; then
              echo "Updating $d/requirements.txt from $d/requirements.in"
              (cd "$d" && pip-compile --upgrade --no-emit-index-url --no-emit-trusted-host -o requirements.txt requirements.in)
            fi
          done

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.DEP_UPDATER_TOKEN }}
          commit-message: |-
            chore(deps): weekly pip-compile upgrade

            Automated update of requirements.txt files using pip-compile --upgrade.
          title: "chore(deps): weekly pip-compile upgrade"
          body: |-
            This PR updates pinned dependencies across services using pip-compile.
            - Generated by GitHub Actions workflow update-deps.yml
            - Please review for major version bumps.
          branch: ci/deps-update
          delete-branch: true
          labels: dependencies
